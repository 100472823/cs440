<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Music Recommender - Homepage</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
</head>
<body>
  <section class="hero">
    <video autoplay muted loop id="bg-video">
      <source src="background2.mp4" type="video/mp4" />
    </video>
    <div class="overlay">
      <h1>Welcome to Beatly</h1>
      <p>Your personal music recommender</p>
      <!-- Browser UI -->
      <div class="browser-container">
        <input type="text" id="song-search" placeholder="Search for songs or artists..." />
      </div>
    </div>
  </section>

  <div class="main-container">
    <header>
      <h1>üé∂ Welcome, <span id="username-display"></span>!</h1>
      <nav>
        <a href="homepage.html">Home</a>
        <a href="#" onclick="logout()">Logout</a>
      </nav>
    </header>

    <main style="width: 90%; max-width: 900px; margin: 20px auto;">

      <!-- Liked Songs -->
      <section class="card" style="margin-bottom: 20px;">
        <h2>‚ù§Ô∏è Your Liked Songs</h2>
        <ul id="liked-songs" class="song-list"></ul>
      </section>

      <!-- Playlists -->
      <section class="card" style="margin-bottom: 20px;">
        <h2>üìÇ Your Playlists</h2>
        <button onclick="toggleCreatePlaylistForm()">‚ûï Create New Playlist</button>
        <div id="create-playlist-form" style="display: none; margin-top: 10px;">
          <input type="text" id="new-playlist-name" placeholder="Playlist name..." />
          <button onclick="createPlaylist()">Create</button>
        </div>
        <ul id="user-playlists" class="song-list" style="margin-top: 15px;"></ul>
      </section>

      <!-- Recommendations -->
      <section class="card" style="margin-bottom: 20px;">
        <h2>Recommended for You</h2>
        <ul id="recommended-songs" class="song-list"></ul>
      </section>

      <!-- All Songs -->
      <section class="card">
        <h2>üéµ All Songs</h2>
        <ul id="all-songs" class="song-list"></ul>
      </section>
    </main>

    <footer>
      <p>&copy; CS440 Group 11</p>
    </footer>
  </div>

  <!-- SCRIPT: L√≥gica de homepage -->
  <script>
    // Check if user is logged in
    const loggedInUser = localStorage.getItem('loggedInUser');
    if (!loggedInUser) {
      // If not logged, redirect to index (or login)
      window.location.href = 'login.html';
    }

    // Display username
    const usernameDisplay = document.getElementById('username-display');
    usernameDisplay.textContent = loggedInUser;

    // Logout function
    function logout() {
      localStorage.removeItem('loggedInUser');
      window.location.href = 'index.html';
    }

    // ---- PLAYLISTS: toggle create form ----
    function toggleCreatePlaylistForm() {
      const form = document.getElementById('create-playlist-form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    // ---- PLAYLISTS: create new playlist (example) ----
    async function createPlaylist() {
      const playlistName = document.getElementById('new-playlist-name').value.trim();
      if (!playlistName) return alert("Please enter a playlist name!");

      try {
        const res = await fetch(`/users/${loggedInUser}/playlists`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ playlistName })
        });
        const data = await res.json();
        if (res.ok) {
          alert("Playlist created!");
          // Clear input
          document.getElementById('new-playlist-name').value = '';
          toggleCreatePlaylistForm();
          // Reload the playlists
          loadUserPlaylists();
        } else {
          alert(data.message || "Error creating playlist");
        }
      } catch (error) {
        console.error("Error creating playlist:", error);
      }
    }

    // ---- Load user data on page load ----
    window.addEventListener('DOMContentLoaded', () => {
      loadLikedSongs();
      loadRecommendedSongs();
      loadAllSongs();
      loadUserPlaylists();
    });

    // ---- Liked Songs ----
    async function loadLikedSongs() {
      try {
        const response = await fetch(`/users/${loggedInUser}/liked`);
        const likedSongs = await response.json();
        renderSongList(likedSongs, 'liked-songs');
      } catch (error) {
        console.error("Error fetching liked songs:", error);
      }
    }

    // ---- Recommended Songs ----
    async function loadRecommendedSongs() {
      try {
        const response = await fetch(`/recommendations/${loggedInUser}`);
        const recData = await response.json();
        // Si tu recommendation-service retorna { recommendedSongs: [...], user: "..." }
        const songs = recData.recommendedSongs || recData;
        renderSongList(songs, 'recommended-songs');
      } catch (error) {
        console.error("Error fetching recommended songs:", error);
      }
    }

    // ---- All Songs (Music Service) ----
    async function loadAllSongs() {
      try {
        const response = await fetch("/music/songs");
        const allSongs = await response.json();
        renderSongList(allSongs, 'all-songs');
      } catch (error) {
        console.error("Error fetching all songs:", error);
      }
    }

    // ---- User Playlists (optional) ----
    async function loadUserPlaylists() {
      try {
        // Suponiendo que tu user-service tenga un GET /users/:username/playlists
        // Si no lo tienes, ajusta la ruta o elimina esta funci√≥n
        const response = await fetch(`/users/${loggedInUser}/playlists`);
        if (response.ok) {
          const playlists = await response.json();
          const container = document.getElementById('user-playlists');
          container.innerHTML = "";
          playlists.forEach(pl => {
            const li = document.createElement('li');
            li.textContent = `${pl.name} (${pl.songs?.length || 0} songs)`;
            container.appendChild(li);
          });
        }
      } catch (error) {
        console.error("Error fetching user playlists:", error);
      }
    }

    // ---- Helper: render array of songs into a UL ----
    function renderSongList(songs, ulId) {
      const ul = document.getElementById(ulId);
      ul.innerHTML = "";
      songs.forEach(song => {
        const li = document.createElement('li');
        // Asumiendo que cada 'song' es un objeto { title, artist, genre }
        if (song.title && song.artist && song.genre) {
          li.textContent = `${song.title} - ${song.artist} [${song.genre}]`;
        } else {
          // Si tu backend retorna otro formato, ajusta aqu√≠
          li.textContent = JSON.stringify(song);
        }
        ul.appendChild(li);
      });
    }
  </script>
</body>
</html>
